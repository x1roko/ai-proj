<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <div class="top-bar">
        <button id="theme-toggle" onclick="toggleTheme()">üåô</button>
        <button id="clear-history" onclick="clearHistory()" class="clear-button">
            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
        </button>
        <div id="account-button" class="account-button" style="display: none;">
            <span id="username-display"></span>
            <div class="account-dropdown">
                <button onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- –°–µ–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ -->
        <div id="mode-selection" style="display: none;">
            <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º</h2>
            <button onclick="showAuthForm()">–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</button>
            <button onclick="startAnonymousChat()">–ê–Ω–æ–Ω–∏–º–Ω—ã–π —á–∞—Ç</button>
        </div>

        <!-- –°–µ–∫—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
        <div id="auth-section" style="display: none;">
            <div id="login-form">
                <h2>–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</h2>
                <div class="form-group">
                    <input type="text" id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
                    <div class="auth-buttons">
                        <button onclick="login()" class="auth-button">–í–æ–π—Ç–∏</button>
                        <button onclick="register()" class="auth-button">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è —á–∞—Ç–∞ -->
        <div id="chat-section" style="display: none;">
            <div id="chat-history"></div>
            <div class="input-area">
                <textarea id="message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
                <button id="send-button" onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    const token = localStorage.getItem('token');
    if (token) {
        validateAndRestoreSession();
    } else {
        showModeSelection();
    }

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º—É –∏–∑ localStorage
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
        currentTheme = savedTheme;
        document.documentElement.setAttribute('data-theme', currentTheme);
        updateThemeButton();
    }
});

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
async function validateAndRestoreSession() {
    const token = localStorage.getItem('token');
    if (!token) {
        showModeSelection();
        return;
    }

    try {
        const response = await fetch('/api/auth/validate-token', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        const data = await response.json();
        
        if (response.ok && data.valid) {
            updateUserInterface(data.username);
            showChat();
            loadHistory();
        } else {
            // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω,
            // —É–¥–∞–ª—è–µ–º —Ç–æ–∫–µ–Ω –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞
            localStorage.removeItem('token');
            showModeSelection();
        }
    } catch (error) {
        console.error('Error validating token:', error);
        localStorage.removeItem('token');
        showModeSelection();
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function updateUserInterface(username) {
    const accountButton = document.getElementById('account-button');
    const usernameDisplay = document.getElementById('username-display');
    
    accountButton.style.display = 'block';
    usernameDisplay.textContent = username;
}

// –§—É–Ω–∫—Ü–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å–µ–∫—Ü–∏–π
function showModeSelection() {
    document.getElementById('mode-selection').style.display = 'block';
    document.getElementById('auth-section').style.display = 'none';
    document.getElementById('chat-section').style.display = 'none';
}

function showAuthForm() {
    document.getElementById('mode-selection').style.display = 'none';
    document.getElementById('auth-section').style.display = 'block';
    document.getElementById('chat-section').style.display = 'none';
}

function showChat() {
    document.getElementById('mode-selection').style.display = 'none';
    document.getElementById('auth-section').style.display = 'none';
    document.getElementById('chat-section').style.display = 'block';
}

// –§—É–Ω–∫—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
async function login() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    try {
        const response = await fetch('/ai/api/auth/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (response.ok) {
            localStorage.setItem('token', data.access_token);
            updateUserInterface(data.username);
            showChat();
            loadHistory();
        } else {
            alert(data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –≤—Ö–æ–¥–∞');
    }
}

async function register() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    try {
        const response = await fetch('/ai/api/auth/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (response.ok) {
            localStorage.setItem('token', data.access_token);
            updateUserInterface(data.username);
            showChat();
        } else {
            alert(data.error || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
    }
}

async function logout() {
    try {
        localStorage.removeItem('token');
        document.getElementById('account-button').style.display = 'none';
        document.getElementById('chat-history').innerHTML = '';
        showModeSelection();
    } catch (error) {
        console.error('Error during logout:', error);
    }
}

// –§—É–Ω–∫—Ü–∏–∏ —á–∞—Ç–∞
async function sendMessage() {
    const messageInput = document.getElementById('message');
    const sendButton = document.getElementById('send-button');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    messageInput.value = '';
    messageInput.disabled = true;
    sendButton.disabled = true;
    
    try {
        // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
        const chatHistory = document.getElementById('chat-history');
        const messageContainer = document.createElement('div');
        messageContainer.className = 'message-container';
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const userDiv = document.createElement('div');
        userDiv.className = 'message user-message';
        userDiv.innerHTML = `<strong>–í—ã:</strong> ${formatMessage(message)}`;
        messageContainer.appendChild(userDiv);
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞
        const botDiv = document.createElement('div');
        botDiv.className = 'message bot-message';
        botDiv.innerHTML = '<strong>–ë–æ—Ç:</strong> <span class="typing-cursor"></span>';
        messageContainer.appendChild(botDiv);
        
        chatHistory.appendChild(messageContainer);
        messageContainer.scrollIntoView({ behavior: 'smooth' });

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
        const token = localStorage.getItem('token');
        const response = await fetch('/api/chat/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                ...(token ? { 'Authorization': `Bearer ${token}` } : {})
            },
            body: JSON.stringify({ message })
        });

        const reader = response.body.getReader();
        let botResponse = '';

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const text = new TextDecoder().decode(value);
            const lines = text.split('\n');

            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    const data = JSON.parse(line.slice(6));
                    botResponse = data.full_response;
                    botDiv.innerHTML = `<strong>–ë–æ—Ç:</strong> ${formatMessage(botResponse)}`;
                }
            }
        }

        messageContainer.scrollIntoView({ behavior: 'smooth' });
    } catch (error) {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
    } finally {
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        messageInput.disabled = false;
        sendButton.disabled = false;
        messageInput.focus();
    }
}

// –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
function formatMessage(text) {
    // –ó–∞–º–µ–Ω—è–µ–º –æ–±—ã—á–Ω—ã–µ –±–ª–æ–∫–∏ –∫–æ–¥–∞
    text = text.replace(/```([\s\S]*?)```/g, function(match, code) {
        return `<div class="code-block">
                    <button class="copy-button" onclick="copyCode(this)">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    <pre><code>${escapeHtml(code.trim())}</code></pre>
                </div>`;
    });
    
    // –ó–∞–º–µ–Ω—è–µ–º inline –∫–æ–¥
    text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    // –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
    text = text.replace(/\n/g, '<br>');
    
    return text;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function copyCode(button) {
    const codeBlock = button.nextElementSibling.textContent;
    navigator.clipboard.writeText(codeBlock).then(() => {
        const originalText = button.textContent;
        button.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        setTimeout(() => {
            button.textContent = originalText;
        }, 2000);
    });
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
document.getElementById('message').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

function startAnonymousChat() {
    showChat();
    localStorage.removeItem('token');
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
async function loadHistory() {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/chat/history', {
            headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        const data = await response.json();
        
        if (!data.history) return;
        
        const chatHistory = document.getElementById('chat-history');
        chatHistory.innerHTML = '';
        
        data.history.forEach(item => {
            const messageContainer = document.createElement('div');
            messageContainer.className = 'message-container';
            
            const userDiv = document.createElement('div');
            userDiv.className = 'message user-message';
            userDiv.innerHTML = `<strong>–í—ã:</strong> ${formatMessage(item.user_message)}`;
            
            const botDiv = document.createElement('div');
            botDiv.className = 'message bot-message';
            botDiv.innerHTML = `<strong>–ë–æ—Ç:</strong> ${formatMessage(item.bot_response)}`;
            
            messageContainer.appendChild(userDiv);
            messageContainer.appendChild(botDiv);
            chatHistory.appendChild(messageContainer);
        });
        
        if (chatHistory.lastElementChild) {
            chatHistory.lastElementChild.scrollIntoView({ behavior: 'smooth' });
        }
    } catch (error) {
        console.error('Error loading history:', error);
    }
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–µ–º–æ–π
let currentTheme = localStorage.getItem('theme') || 'light';

function toggleTheme() {
    currentTheme = currentTheme === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', currentTheme);
    localStorage.setItem('theme', currentTheme);
    updateThemeButton();
}

function updateThemeButton() {
    const themeButton = document.getElementById('theme-toggle');
    themeButton.textContent = currentTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
}
</script>
</body>
</html>